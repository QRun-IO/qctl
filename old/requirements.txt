⸻

qctl — Requirements Prompt (Design First)

You are acting as a principal engineer + product architect.
Your task is to design a new Java CLI tool called qctl that controls the full lifecycle of qqq applications.

High-Level Goals
	•	One executable with four modes (subcommands):
	1.	qctl qqq – Scaffold new 0→1 qqq apps from signed remote templates; support “one command to running app” and advanced generation via YAML input.
	2.	qctl qbit – Discover/download/install/update/remove qBits from a central registry; manage vendored vs linked usage, version resolution, integrity, and lockfiles (npm/pnpm-like).
	3.	qctl qrun – Heroku-like lifecycle: package, verify, publish, promote, monitor across dev/stage/qa/prod on qRun servers (auth, secrets, rollbacks, status, logs).
	4.	qctl qstudio – Ingest local code/rules/db/schema + a user request, assemble prompts, call LLM providers, and generate production-ready code/models/tests/migrations aligned to qqq conventions with guardrails.
	•	Cross-platform: macOS, Linux, Windows.
	•	Standalone binary distribution (no system JRE required).
	•	One-line install from our website for all OSes.
	•	Design first: produce a complete design + checklist before generating any code.

Constraints & Assumptions
	•	Language: Java (latest LTS) at build time. Use Temurin distribution. Provide guidance to bump when a newer LTS ships.
	•	Packaging: Prefer GraalVM Native Image for single-binary; fallback: jlink/jpackage.
	•	Build: Maven (unless strong reason for Gradle).
	•	Versioning: SemVer for CLI and registries/APIs.
	•	Offline: Caching for templates/qBits/artifacts; reproducible builds.
	•	Security: Signed templates/qBits, SBOM, supply-chain validation; opt-in telemetry only.
	•	Production domain: qrun.io. Default endpoints:
	•	Templates: templates.qrun.io
	•	qBit Registry: registry.qrun.io
	•	qRun API: api.qrun.io
	•	qStudio Broker: studio.qrun.io
	•	Artifact CDN: cdn.qrun.io
	•	All endpoints overrideable via config/env/flags.

Required Output (do not write code yet)

Produce exactly three sections in Markdown:

⸻

1) Design Document

Provide implementation-ready detail:

CLI UX & Commands
	•	Global flags, subcommand trees, positional args, examples.
	•	Non-interactive vs interactive flows; dry-run; --verbose/--debug; color rules; exit codes.
	•	Shell completion (bash/zsh/fish/pwsh) and man/--help layout.

Architecture
	•	Modules: qctl-core, qctl-qqq, qctl-qbit, qctl-qrun, qctl-qstudio, qctl-shared.
	•	Ports/Adapters for: TemplateProvider, QBitRegistry, QRunAPI, LLMProvider, AuthProvider, InstallerPublisher.
	•	Config hierarchy & precedence: project YAML, global config, env vars, CLI flags.
	•	Local cache layout; content hashing; lockfiles; trust store; signing keys.
	•	Plugin/extension model for third-party subcommands/generators.

qqq (Scaffolding)
	•	Template format/versioning; discovery over templates.qrun.io; signing/trust model.
	•	YAML schema for advanced gen (inputs, validations, computed values).
	•	Post-gen: deps fetch → build → local run → health check; idempotent regeneration.

qBit (Package Manager-like)
	•	Registry API at registry.qrun.io (search, fetch, version ranges, signatures).
	•	Commands: add/update/remove/audit/list/info/publish; conflict & dedupe strategy.
	•	Lockfile spec, integrity checks, vendored vs linked mode.
	•	Security audit and provenance display.

qRun (Env & Deploy)
	•	Packaging format (OCI image or zip+manifest) and metadata.
	•	Pipeline: package → verify → publish → promote → rollback via api.qrun.io.
	•	Env/secret management, config overlays per environment.
	•	AuthN/AuthZ (OIDC) to qRun; token storage; least-privilege scopes.
	•	Observability: logs tail, metrics, health/status, incident links, doctor.

qStudio (LLM Assist)
	•	Sources: code, rules, DB schema, OpenAPI, tests, commit history.
	•	Prompt assembly, chunking, token budgeting; provider abstraction (OpenAI/Anthropic/self-hosted).
	•	Outputs: patch/diff, new modules, migrations, tests, docs; confirmation gates.
	•	Privacy/Compliance: local redaction, allowlist/denylist, activity ledger.
	•	Optional broker endpoint at studio.qrun.io; local/offline mode.

Cross-Platform Packaging & Installers
	•	Build matrix: macOS arm64/x64; Linux x64/arm64; Windows x64.
	•	Installers:
	•	macOS: Homebrew tap + one-liner.
	•	Windows: winget + Scoop.
	•	Linux: one-liner with apt/yum/zypper detection + fallback.
	•	Self-update command (channels, signatures), offline install path.

Security
	•	Code signing, macOS notarization, CycloneDX SBOM, supply-chain checks.
	•	Template/qBit signature verification, registry pinning, optional TLS pinning.
	•	Secret handling (OS keychain), redaction in logs.

DX & Docs
	•	Quickstart, examples dir, --init walkthrough.
	•	qctl diagnostics / qctl doctor.
	•	Completion scripts generation and install helpers.

Developer Experience & IntelliJ Project Standards
	•	Build & Structure
	•	Maven Wrapper (mvnw) with Java Toolchains targeting latest LTS.
	•	Modular layout: core + submodules + integration tests.
	•	Enforce reproducible builds via maven-enforcer-plugin.
	•	Automated dep updates via Renovate/Dependabot.
	•	Code Quality
	•	.editorconfig; IntelliJ set to use it.
	•	Spotless + Google Java Format or Eclipse formatter.
	•	Checkstyle, Error Prone, Nullness annotations.
	•	Qodana config for static analysis.
	•	Testing
	•	JUnit 5, AssertJ, Mockito; coverage via JaCoCo.
	•	Testcontainers for integration tests.
	•	CLI golden tests; fast vs slow profiles.
	•	Security
	•	OWASP Dependency-Check/Snyk; CycloneDX SBOM.
	•	Git/release signing; secrets in OS keychain.
	•	IDE Config
	•	Shareable run configs in .run/ for common tasks.
	•	Code style & inspection profile committed.
	•	Live Templates for scaffolds/tests.
	•	Generated sources & annotation processors configured.
	•	Dev Environment Parity
	•	Devcontainer optional.
	•	Makefile/justfile shortcuts.
	•	Cross-platform scripts in /scripts.
	•	Native Image
	•	Pin GraalVM version; reflection configs committed.
	•	Debug build profile.
	•	jlink/jpackage fallback.
	•	CLI Assets
	•	Shell completions & man pages generated in build.
	•	Pre-wired doctor/diagnostics run configs.
	•	Git & Releases
	•	Conventional Commits; semantic-release or Maven Release Plugin.
	•	CODEOWNERS, PR templates, issue templates.
	•	Branch protection + required CI checks.
	•	Docs
	•	CONTRIBUTING.md, DEVELOPING.md, ARCHITECTURE.md.

Configuration & Default qctl.yaml Schema
	•	Precedence (lowest → highest):
	1.	Built-in defaults
	2.	Global config ($XDG_CONFIG_HOME/qctl/qctl.yaml or OS-specific paths)
	3.	Project config (./qctl.yaml in repo root)
	4.	Environment variables (QCTL_*)
	5.	CLI flags
	•	Default locations:
	•	macOS: ~/Library/Application Support/qctl/qctl.yaml
	•	Linux: $XDG_CONFIG_HOME/qctl/qctl.yaml (fallback ~/.config/qctl/qctl.yaml)
	•	Windows: %APPDATA%\qctl\qctl.yaml
	•	Cache dirs follow OS/XDG: e.g., Linux ~/.cache/qctl, macOS ~/Library/Caches/qctl, Windows %LOCALAPPDATA%\qctl\Cache
	•	Top-level keys (all optional with sane defaults):
	•	endpoints: { templates, registry, api, studio, cdn } (defaults to *.qrun.io)
	•	auth:
	•	provider: oidc
	•	issuer: e.g., https://auth.qrun.io/ (overrideable)
	•	clientId, audience, scopes (default least-privilege)
	•	tokenStore: os-keychain | file (default os-keychain)
	•	profile: named auth profile to use by default
	•	profiles: map of named profiles (e.g., dev, stage, prod) that can override any key via extends + overrides
	•	qrun:
	•	defaultEnv: dev|stage|qa|prod
	•	packageFormat: oci|zip
	•	release: { channel: stable|beta, strategy: blue-green|rolling, rollback: enabled }
	•	secrets: provider: os-keychain|env|file, paths: [] (if file)
	•	qbit:
	•	cacheDir, vendorDir, lockfile: filenames, integrity settings
	•	resolution: { preferLatestMinor: true, dedupe: true }
	•	verifySignatures: true
	•	qqq:
	•	defaultTemplate: web-basic
	•	postGen: [ "build", "run", "healthcheck" ]
	•	generator: { interactive: true, validate: strict }
	•	qstudio:
	•	provider: openai|anthropic|azure|selfhosted
	•	model: string
	•	policy: { redactPaths: [], allowPaths: [], maxTokens: 120000 }
	•	confirmWrites: true
	•	telemetry:
	•	enabled: false
	•	explainCommand: telemetry explain
	•	updates:
	•	autoCheck: true
	•	channel: stable|beta
	•	log:
	•	level: info|debug|trace
	•	format: text|json
	•	color: auto|always|never
	•	Environment variable mapping (examples):
	•	QCTL_ENDPOINTS_API=https://api.qrun.io
	•	QCTL_PROFILE=prod
	•	QCTL_QRUN_DEFAULTENV=prod
	•	QCTL_QBIT_VERIFYSIGNATURES=false
	•	QCTL_QSTUDIO_PROVIDER=selfhosted
	•	QCTL_TELEMETRY_ENABLED=true
	•	Dot-path convention: QCTL_<SECTION>_<SUBKEY>=value (case-insensitive for values where applicable)
	•	CLI flag overrides (examples):
	•	--endpoint.api, --profile, --env, --telemetry.enabled, --log.level, --qstudio.provider
	•	Flags mirror YAML keys using dot-notation; arrays accept repeated flags or CSV.
	•	Profiles & inheritance:
	•	Each profile can extends: base and override keys, e.g., endpoints pointing to staging stacks.
	•	qctl --profile stage qrun publish uses that profile’s merged config.
	•	Sensitive data handling:
	•	auth.tokenStore=os-keychain by default.
	•	If file, tokens live at the global config dir with 0600/600 perms; warn on weaker perms.
	•	Validation:
	•	On startup, validate config against JSON Schema (below); print actionable errors with path to bad key.
	•	JSON Schema (concise):

{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "qctl config",
  "type": "object",
  "properties": {
    "endpoints": {
      "type": "object",
      "properties": {
        "templates": {"type": "string", "format": "uri"},
        "registry":  {"type": "string", "format": "uri"},
        "api":       {"type": "string", "format": "uri"},
        "studio":    {"type": "string", "format": "uri"},
        "cdn":       {"type": "string", "format": "uri"}
      },
      "additionalProperties": false
    },
    "auth": {
      "type": "object",
      "properties": {
        "provider": {"enum": ["oidc"]},
        "issuer": {"type": "string", "format": "uri"},
        "clientId": {"type": "string"},
        "audience": {"type": "string"},
        "scopes": {"type": "array", "items": {"type": "string"}},
        "tokenStore": {"enum": ["os-keychain", "file"]},
        "profile": {"type": "string"}
      },
      "additionalProperties": false
    },
    "profiles": {
      "type": "object",
      "additionalProperties": {"$ref": "#"}
    },
    "qrun": {
      "type": "object",
      "properties": {
        "defaultEnv": {"enum": ["dev","stage","qa","prod"]},
        "packageFormat": {"enum": ["oci","zip"]},
        "release": {
          "type": "object",
          "properties": {
            "channel": {"enum": ["stable","beta"]},
            "strategy": {"enum": ["blue-green","rolling"]},
            "rollback": {"type": "boolean"}
          },
          "additionalProperties": false
        },
        "secrets": {
          "type": "object",
          "properties": {
            "provider": {"enum": ["os-keychain","env","file"]},
            "paths": {"type": "array", "items": {"type": "string"}}
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "qbit": {
      "type": "object",
      "properties": {
        "cacheDir": {"type": "string"},
        "vendorDir": {"type": "string"},
        "lockfile": {"type": "string"},
        "resolution": {
          "type": "object",
          "properties": {
            "preferLatestMinor": {"type": "boolean"},
            "dedupe": {"type": "boolean"}
          },
          "additionalProperties": false
        },
        "verifySignatures": {"type": "boolean"}
      },
      "additionalProperties": false
    },
    "qqq": {
      "type": "object",
      "properties": {
        "defaultTemplate": {"type": "string"},
        "postGen": {"type": "array", "items": {"type": "string"}},
        "generator": {
          "type": "object",
          "properties": {
            "interactive": {"type": "boolean"},
            "validate": {"enum": ["strict","lenient"]}
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "qstudio": {
      "type": "object",
      "properties": {
        "provider": {"enum": ["openai","anthropic","azure","selfhosted"]},
        "model": {"type": "string"},
        "policy": {
          "type": "object",
          "properties": {
            "redactPaths": {"type": "array", "items": {"type": "string"}},
            "allowPaths": {"type": "array", "items": {"type": "string"}},
            "maxTokens": {"type": "integer", "minimum": 1024}
          },
          "additionalProperties": false
        },
        "confirmWrites": {"type": "boolean"}
      },
      "additionalProperties": false
    },
    "telemetry": {
      "type": "object",
      "properties": {
        "enabled": {"type": "boolean"},
        "explainCommand": {"type": "string"}
      },
      "additionalProperties": false
    },
    "updates": {
      "type": "object",
      "properties": {
        "autoCheck": {"type": "boolean"},
        "channel": {"enum": ["stable","beta"]}
      },
      "additionalProperties": false
    },
    "log": {
      "type": "object",
      "properties": {
        "level": {"enum": ["info","debug","trace"]},
        "format": {"enum": ["text","json"]},
        "color": {"enum": ["auto","always","never"]}
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}


	•	Sample qctl.yaml:

endpoints:
  templates: https://templates.qrun.io
  registry:  https://registry.qrun.io
  api:       https://api.qrun.io
  studio:    https://studio.qrun.io
  cdn:       https://cdn.qrun.io

auth:
  provider: oidc
  issuer: https://auth.qrun.io/
  clientId: qctl-cli
  audience: qrun
  scopes: [ "openid", "profile", "offline_access" ]
  tokenStore: os-keychain
  profile: default

qrun:
  defaultEnv: dev
  packageFormat: oci
  release:
    channel: stable
    strategy: rolling
    rollback: true
  secrets:
    provider: os-keychain

qbit:
  vendorDir: vendor/qbits
  lockfile: qbits.lock
  resolution:
    preferLatestMinor: true
    dedupe: true
  verifySignatures: true

qqq:
  defaultTemplate: web-basic
  postGen: [ "build", "run", "healthcheck" ]
  generator:
    interactive: true
    validate: strict

qstudio:
  provider: selfhosted
  model: "enterprise-default"
  policy:
    redactPaths: [ "**/*.pem", "**/secrets/**" ]
    allowPaths:  [ "src/**", "rules/**", "schema/**" ]
    maxTokens: 120000
  confirmWrites: true

telemetry:
  enabled: false
  explainCommand: "telemetry explain"

updates:
  autoCheck: true
  channel: stable

log:
  level: info
  format: text
  color: auto

profiles:
  stage:
    endpoints:
      api: https://api.stage.qrun.io
    qrun:
      defaultEnv: stage
  prod:
    endpoints:
      api: https://api.qrun.io
    qrun:
      defaultEnv: prod



Testing & CI/CD
	•	Unit/contract/e2e tests; golden snapshots.
	•	Installer smoke tests; upgrade/downgrade; reproducibility checks.
	•	CI: build → sign → package → publish to taps/winget/scoop/site.

Telemetry & Privacy
	•	Default: off; opt-in lists exact events/fields; local view/export; telemetry explain.

Risks & Mitigations
	•	GraalVM native quirks; Windows paths; template security; LLM hallucinations; registry uptime.
	•	Fallbacks and runbooks.

⸻

2) Build Checklist

An ordered, step-by-step checklist to implement the design.
Each step must include:
	•	Objective
	•	Artifacts (modules/files/configs)
	•	Definition of done
	•	Dependencies
	•	Owner role (if helpful)

Include milestones for MVP, Beta, GA, and Hardening.

⸻

3) Open Questions

List assumptions needing confirmation.
Where multiple options exist, propose a recommended default with trade-offs.

⸻

Non-Negotiable Rules
	•	Do not write code yet. Deliver the design doc, checklist, and open questions only.
	•	Use concise Markdown with headings, bullets, and short command examples.
	•	State why for each external dependency.

⸻

Reference Command Examples

# qqq (scaffold)
qctl qqq new my-app --template web-basic --non-interactive
qctl qqq generate --spec app.yaml --dry-run

# qBit (packages)
qctl qbit search auth
qctl qbit add io.qbits/auth@^2
qctl qbit update
qctl qbit audit

# qRun (env & deploy)
qctl qrun package
qctl qrun publish --env stage
qctl qrun promote --from stage --to prod
qctl qrun logs --app my-app --env prod --follow

# qStudio (LLM assist)
qctl qstudio enhance --request "add RBAC to admin panel" --confirm
qctl qstudio plan --rules rules.yaml --out plan.md


⸻
